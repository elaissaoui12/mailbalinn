"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([["9097"],{54538:function(e,a,t){t.d(a,{DP:()=>w,Ew:()=>c,I5:()=>m,JI:()=>h,L3:()=>r,Nh:()=>y,UY:()=>g,WJ:()=>p,nn:()=>_});var l=t(76882),n=t(34541),i=t(58786);let{t:o}=l.Z.global,s={fetchOptions:{loading:o("template.ai.loading.message"),successMessage:!0}};async function u(e,a){try{await n.e.post("/email_template/create",{temp_name:a,add_type:2,chat_id:e,html_content:""})}catch(e){throw console.warn(e),e}}async function r(e){await d(e),await v(e)}async function c(e){try{let a=`AI_temp_${new Date().getTime()}`,t=await n.e.post("/askai/chat/create_chat",{domain:e,add_type:99,temp_name:a},s);return await u(t.chatId,a),t.chatId}catch(e){return console.warn(e),null}}async function d(e){let{modelList:a,currentModel:t,currentModelTitle:l}=e;try{a.value=await n.e.post("/askai/supplier/models"),a.value.length&&(t.value=a.value[0],l.value=a.value[0].title)}catch(e){console.warn(e)}}async function v(e){let{chatId:a,chatInfo:t,currentModel:l,modelList:i,currentModelTitle:o,chatRecord:s,usageRecord:u}=e;try{if(t.value=await n.e.post("/askai/chat/info",{chatId:a.value}),t.value.modelId&&i.value.length){let e=i.value.find(e=>e.modelId==t.value.modelId);e&&(l.value=e,o.value=e.title)}for(let e=0;e<t.value.messages.length;e++){let a=`${t.value.messages[e].content}_+_${s.value.size}`;"user"==t.value.messages[e].role&&(s.value.set(a,f(t.value.messages[e+1].content)),u.value.set(a,t.value.messages[e+1].usage))}}catch(e){console.warn(e)}}async function m(e){let{chatId:a,isChat:t}=e;try{await n.e.post("/askai/chat/stop",{chatId:a.value},s),t.value=!1}catch(e){console.warn(e)}}async function p(e,a){let{scrollable:t,generateShow:l,chatId:s,currentModel:u,questionContent:r,chatRecord:c,currentChatRecordKey:d,scrollWrapperRef:v,chatScrollRef:m,isChat:p,usageRecord:h,useSpinTax:g,spinTaxLength:w}=e;if(p.value||!r.value||a&&function(e,a){if(e.shiftKey&&"Enter"===e.key){e.preventDefault();let t=e.target,l=t.selectionStart,n=t.selectionEnd;return a.value=a.value.substring(0,l)+"\n"+a.value.substring(n),t.selectionStart=t.selectionEnd=l+1,!0}}(a,r))return;let _=`${r.value}_+_${c.value.size}`;c.value.set(_,[]),d.value=_;let k=r.value;r.value="";let S=[],U="",b=0;g.value&&(k+=`  ${o("template.ai.spintax.instruction",{count:w.value})}`);try{t.value=!0,l.value=!0,p.value=!0,(0,i.Y3)(()=>m.value.scrollTo({left:0,top:v.value.offsetHeight})),await n.e.post("/askai/chat/chat",{chatId:s.value,supplierName:u.value.supplierName,modelId:u.value.modelId,content:k,is_text:"false"},{fetchOptions:{cancelResInterceptor:!0},responseType:"text",onDownloadProgress:e=>{l.value=!1;try{let l=e.event.target.responseText,n=l.slice(b);b=l.length;var a=function(e){let a=e.split("\n"),t=[];for(let e of a){let a=e.trim();if(a.startsWith("data:")){let e=a.slice(5).trim();e&&t.push(e)}}return t}(n);for(let e=0;e<a.length;e++)a[e]&&(U+=JSON.parse(a[e]).content);c.value.set(_,f(U)),t.value&&setTimeout(()=>m.value.scrollTo({left:0,top:v.value.offsetHeight}),200)}catch(e){console.warn(e)}}}),t.value=!0,m.value.scrollTo({left:0,top:v.value.offsetHeight}),p.value=!1,y(e,e=>{h.value.set(_,e)})}catch(e){console.warn(e)}finally{l.value=!1,U="",b=0}}function f(e){let a=/```[\s\S]*?(?:```|$)/g,t=e.match(a)||[],l=e.split(a),n=[],i=Math.max(l.length,t.length);for(let e=0;e<i;e++)e<l.length&&""!==l[e].trim()&&n.push(l[e]),e<t.length&&n.push(t[e]);return n}function h(e){return e.replace(/```html/g,"").replace(/```$/gm,"")}function g(e){return e.replace(/<<<<<<<\s+SEARCH[\s\S]*?=======([\s\S]*?)>>>>>>>\s+REPLACE/g,"$1")}function w(e){let a=e.match(/<title>(.*?)<\/title>/i);return a?a[1]:""}async function y(e,a){let{chatId:t,previewCode:l,previewTit:i}=e;try{let e=await n.e.post("/askai/chat/get_html",{chatId:t.value});l.value=e.html_content,i.value=w(l.value),a&&a(e.last_usage)}catch(e){console.warn(e)}}async function _(e){let{previewCode:a,chatId:t}=e;try{await n.e.post("/askai/chat/modify_html",{chatId:t.value,content:a.value},s),y(e)}catch(e){console.warn(e)}}},99778:function(e,a,t){t.d(a,{Z:()=>z});var l=t(5057),n=t(49942),i=t(40972),o=t(15496),s=t(8490),u=t(58786),r=t(34541),c=t(54538),d=t(31708),v=t(39432);let m=t.p+"static/image/model-notice.a300ae20.png",p=t.p+"static/image/create-brand-info.5daf2552.png";var f=t(68271),h=t(54686),g=t(65965);let w={class:"wrapper"},y={class:"creation-methods"},_=["onClick"],k={class:"item-label"},S={class:"label"},U={key:0,class:"desc"},b={key:1},I={key:2},T={key:3},$={class:"flex justify-end"},C=(0,u.aZ)({__name:"CreateTplModal",props:{onlyAi:{type:Boolean}},emits:["confirmType","hasCreateTpl"],setup(e,a){let{expose:t,emit:C}=a,z=(0,d.s6)(),A=(0,g.tv)(),D=(0,u.iH)(["Drag","AI","HTML"]),W=(0,u.iH)("AI"),H=(0,u.iH)(""),x=(0,u.iH)(null),E=(0,u.iH)(!1),Z=(0,u.iH)([]),N=(0,u.iH)(!1),F=(0,u.Fl)(()=>e.onlyAi?["AI"]:D.value),L=(0,u.Fl)(()=>{if(0==M.value.length)return"domain-list-empty";if(!N.value)return"ai-configuration-invalid";let e=Z.value.find(e=>e.domain==H.value);return e&&1!==e.hasbrandinfo?"invalid-brand-domain":"normal"}),M=(0,u.Fl)(()=>[...Z.value].sort((e,a)=>a.hasbrandinfo-e.hasbrandinfo)),P=(0,u.Fl)(()=>"AI"==W.value&&0==M.value.length);async function j(){if("AI"==W.value){if("invalid-brand-domain"==L.value){let e=Z.value.find(e=>e.domain===H.value);try{await (0,v.rU)({domain:H.value,urls:e.urls}),(0,h.ke)(H.value,1)}catch(e){f.v0.error("Failed to initialize AI configuration, please try again later."),console.warn(e)}}let e=await (0,c.Ew)(H.value);e&&(z.domainSource=H.value,A.push({name:"ai-template",params:{chatId:e}}))}else C("confirmType",W.value)}function q(){A.push({name:"Domain",query:{init:"init-domain"}})}function J(){A.push({name:"AiModel"})}function O(){A.push({name:"EditDomain",params:{domain:H.value}})}function R(e){return e.hasbrandinfo?(0,u.Wm)("div",null,[(0,u.Wm)("i",{class:"i-domain:brand-info w-4 h-4 mr-1.25"},null),(0,u.Uk)(" "),(0,u.Wm)("span",null,[e.domain])]):(0,u.Wm)("span",null,[e.domain])}async function Y(){if(Z.value=(await r.e.get("/domains/list",{params:{page:1,page_size:100}})).list,x.value=Z.value.find(e=>e.domain===H.value)||null,0==Z.value.length){z.domainSource="",H.value="";return}z.domainSource&&(H.value=z.domainSource),M.value.length>0&&(H.value=M.value[0].domain,z.domainSource=M.value[0].domain)}return t({open:async function e(){N.value=(await (0,v.Lb)()).is_configured,await Y(),z.domainSource&&(z.domainSource=H.value),E.value=!0},close:function(){E.value=!1}}),(e,a)=>{let t=s.Z,r=o.ZP,c=i.Z,d=n.ZP,v=l.Z;return(0,u.wg)(),(0,u.j4)(v,{show:(0,u.SU)(E),"onUpdate:show":a[1]||(a[1]=e=>(0,u.dq)(E)?E.value=e:null),preset:"card",draggable:"","close-on-esc":!1,"mask-closable":!1,segmented:"",class:"w-110",title:""},{footer:(0,u.w5)(()=>[(0,u._)("div",$,["AI"==(0,u.SU)(W)?((0,u.wg)(),(0,u.j4)(r,{key:0,type:"primary",disabled:(0,u.SU)(P)||["domain-list-empty","ai-configuration-invalid"].includes((0,u.SU)(L)),onClick:j},{default:(0,u.w5)(()=>[(0,u.Uk)((0,u.zw)(e.$t("template.createTpl.create")),1)]),_:1},8,["disabled"])):((0,u.wg)(),(0,u.j4)(r,{key:1,type:"primary",onClick:j},{default:(0,u.w5)(()=>[(0,u.Uk)((0,u.zw)(e.$t("template.createTpl.create")),1)]),_:1}))])]),default:(0,u.w5)(()=>[(0,u._)("div",w,[(0,u._)("div",y,[((0,u.wg)(!0),(0,u.iD)(u.HY,null,(0,u.Ko)((0,u.SU)(F),(e,a)=>((0,u.wg)(),(0,u.iD)("div",{key:a,class:(0,u.C_)(["choose-item",{active:(0,u.SU)(W)==e}]),onClick:a=>W.value=e},[(0,u._)("span",k,(0,u.zw)(e),1)],10,_))),128))]),(0,u._)("div",{class:(0,u.C_)(["url-source",{hidden:"AI"!==(0,u.SU)(W)}])},[(0,u._)("span",S,(0,u.zw)(e.$t("template.createTpl.sourceUrl")),1),(0,u.Wm)(t,{value:(0,u.SU)(H),"onUpdate:value":a[0]||(a[0]=e=>(0,u.dq)(H)?H.value=e:null),class:"flex-1","label-field":"domain","value-field":"domain",options:(0,u.SU)(M),disabled:(0,u.SU)(P),"render-label":R},null,8,["value","options","disabled"])],2),"normal"==(0,u.SU)(L)?((0,u.wg)(),(0,u.iD)("div",U,(0,u.zw)(e.$t("template.createTpl.useAiTools")),1)):"domain-list-empty"==(0,u.SU)(L)?((0,u.wg)(),(0,u.iD)("div",b,[(0,u.Uk)((0,u.zw)(e.$t("template.createTpl.notices.domainListEmpty"))+", ",1),(0,u.Wm)(r,{text:"",type:"primary",onClick:q},{default:(0,u.w5)(()=>[(0,u.Uk)((0,u.zw)(e.$t("template.createTpl.buttons.createNow")),1)]),_:1})])):"ai-configuration-invalid"==(0,u.SU)(L)?((0,u.wg)(),(0,u.iD)("div",I,[(0,u.Uk)((0,u.zw)(e.$t("template.createTpl.notices.aiConfigurationInvalid"))+", ",1),(0,u.Wm)(d,{trigger:"hover",placement:"right"},{trigger:(0,u.w5)(()=>[(0,u.Wm)(r,{text:"",type:"primary",onClick:J},{default:(0,u.w5)(()=>[(0,u.Uk)((0,u.zw)(e.$t("template.createTpl.buttons.configureNow")),1)]),_:1})]),default:(0,u.w5)(()=>[(0,u.Wm)(c,{src:(0,u.SU)(m),width:"600"},null,8,["src"])]),_:1})])):"invalid-brand-domain"==(0,u.SU)(L)?((0,u.wg)(),(0,u.iD)("div",T,[(0,u.Uk)((0,u.zw)(e.$t("template.createTpl.notices.invalidBrandDomain"))+", ",1),(0,u.Wm)(d,{trigger:"hover",placement:"right"},{trigger:(0,u.w5)(()=>[(0,u.Wm)(r,{text:"",type:"primary",onClick:O},{default:(0,u.w5)(()=>[(0,u.Uk)((0,u.zw)(e.$t("template.createTpl.buttons.createNow")),1)]),_:1})]),default:(0,u.w5)(()=>[(0,u.Wm)(c,{src:(0,u.SU)(p),width:"600"},null,8,["src"])]),_:1})])):(0,u.kq)("",!0)])]),_:1},8,["show"])}}}),z=(0,t(41748).default)(C,[["__scopeId","data-v-c97e6920"]])}}]);